{
  "query": "\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: STOCK INTEGRITY ENGINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── STOCK RESERVATIONS ──────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `stock_reservations` (\n  `id`              INT AUTO_INCREMENT PRIMARY KEY,\n  `inventoryItemId` INT NOT NULL,\n  `invoiceId`       INT NOT NULL,\n  `invoiceType`     ENUM('Sale','Transfer','PurchaseOrder') NOT NULL,\n  `branchId`        INT NOT NULL,\n  `productId`       INT NOT NULL,\n  `quantity`        INT NOT NULL DEFAULT 1,\n  `status`          ENUM('Active','Released','Consumed') NOT NULL DEFAULT 'Active',\n  `createdAt`       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `releasedAt`      TIMESTAMP,\n  CONSTRAINT `fk_sr_inventory` FOREIGN KEY (`inventoryItemId`) REFERENCES `inventory_items`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_sr_branch`    FOREIGN KEY (`branchId`)        REFERENCES `branches`(`id`)        ON DELETE CASCADE,\n  CONSTRAINT `fk_sr_product`   FOREIGN KEY (`productId`)       REFERENCES `products`(`id`)       ON DELETE CASCADE,\n  INDEX `idx_res_inventory` (`inventoryItemId`),\n  INDEX `idx_res_invoice` (`invoiceId`),\n  INDEX `idx_res_branch` (`branchId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: PURCHASE WORKFLOW PIPELINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── PURCHASE ORDERS ─────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_orders` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `poNo`             VARCHAR(32) NOT NULL UNIQUE,\n  `supplierId`       INT NOT NULL,\n  `warehouseBranchId` INT NOT NULL,\n  `createdByUserId`  INT NOT NULL,\n  `status`           ENUM('Draft','Submitted','Approved','Cancelled') NOT NULL DEFAULT 'Draft',\n  `totalAmount`      DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `notes`            TEXT,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `submittedAt`      TIMESTAMP,\n  `approvedAt`       TIMESTAMP,\n  `cancelledAt`      TIMESTAMP,\n  CONSTRAINT `fk_po_supplier`   FOREIGN KEY (`supplierId`)       REFERENCES `suppliers`(`id`)  ON DELETE RESTRICT,\n  CONSTRAINT `fk_po_warehouse`  FOREIGN KEY (`warehouseBranchId`) REFERENCES `branches`(`id`)   ON DELETE RESTRICT,\n  CONSTRAINT `fk_po_user`       FOREIGN KEY (`createdByUserId`)   REFERENCES `users`(`id`)      ON DELETE RESTRICT,\n  INDEX `idx_po_supplier` (`supplierId`),\n  INDEX `idx_po_warehouse` (`warehouseBranchId`),\n  INDEX `idx_po_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PURCHASE ORDER ITEMS ────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_order_items` (\n  `id`         INT AUTO_INCREMENT PRIMARY KEY,\n  `poId`       INT NOT NULL,\n  `productId`  INT NOT NULL,\n  `quantity`   INT NOT NULL,\n  `unitPrice`  DECIMAL(12,2) NOT NULL,\n  `totalPrice` DECIMAL(12,2) NOT NULL,\n  `createdAt`  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_poi_po`      FOREIGN KEY (`poId`)      REFERENCES `purchase_orders`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_poi_product` FOREIGN KEY (`productId`) REFERENCES `products`(`id`)        ON DELETE RESTRICT,\n  INDEX `idx_poi_po` (`poId`),\n  INDEX `idx_poi_product` (`productId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── GOODS RECEIVED NOTES ────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `goods_received_notes` (\n  `id`                  INT AUTO_INCREMENT PRIMARY KEY,\n  `grnNo`               VARCHAR(32) NOT NULL UNIQUE,\n  `poId`                INT NOT NULL,\n  `supplierId`          INT NOT NULL,\n  `warehouseBranchId`   INT NOT NULL,\n  `receivedByUserId`    INT NOT NULL,\n  `status`              ENUM('Pending','Received','Reversed') NOT NULL DEFAULT 'Pending',\n  `totalReceivedAmount` DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `notes`               TEXT,\n  `createdAt`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `receivedAt`          TIMESTAMP,\n  `reversedAt`          TIMESTAMP,\n  CONSTRAINT `fk_grn_po`        FOREIGN KEY (`poId`)                REFERENCES `purchase_orders`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_supplier`  FOREIGN KEY (`supplierId`)          REFERENCES `suppliers`(`id`)      ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_warehouse` FOREIGN KEY (`warehouseBranchId`)   REFERENCES `branches`(`id`)       ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_user`      FOREIGN KEY (`receivedByUserId`)    REFERENCES `users`(`id`)         ON DELETE RESTRICT,\n  INDEX `idx_grn_po` (`poId`),\n  INDEX `idx_grn_supplier` (`supplierId`),\n  INDEX `idx_grn_warehouse` (`warehouseBranchId`),\n  INDEX `idx_grn_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── GRN ITEMS ───────────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `grn_items` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`            INT NOT NULL,\n  `poItemId`         INT NOT NULL,\n  `productId`        INT NOT NULL,\n  `quantityReceived` INT NOT NULL,\n  `unitPrice`        DECIMAL(12,2) NOT NULL,\n  `totalPrice`       DECIMAL(12,2) NOT NULL,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_grni_grn`     FOREIGN KEY (`grnId`)     REFERENCES `goods_received_notes`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_grni_poitem`  FOREIGN KEY (`poItemId`)  REFERENCES `purchase_order_items`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_grni_product` FOREIGN KEY (`productId`) REFERENCES `products`(`id`)             ON DELETE RESTRICT,\n  INDEX `idx_grni_grn` (`grnId`),\n  INDEX `idx_grni_product` (`productId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── LANDING COSTS ───────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `landing_costs` (\n  `id`          INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`       INT NOT NULL,\n  `costType`    VARCHAR(64) NOT NULL,\n  `amount`      DECIMAL(12,2) NOT NULL,\n  `description` TEXT,\n  `createdAt`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_lc_grn` FOREIGN KEY (`grnId`) REFERENCES `goods_received_notes`(`id`) ON DELETE CASCADE,\n  INDEX `idx_lc_grn` (`grnId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PURCHASE FINALIZATIONS ──────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_finalizations` (\n  `id`                  INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`               INT NOT NULL,\n  `poId`                INT NOT NULL,\n  `supplierId`          INT NOT NULL,\n  `warehouseBranchId`   INT NOT NULL,\n  `finalizedByUserId`   INT NOT NULL,\n  `baseAmount`          DECIMAL(12,2) NOT NULL,\n  `totalLandingCosts`   DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `finalAmount`         DECIMAL(12,2) NOT NULL,\n  `payableEntryId`      INT,\n  `status`              ENUM('Pending','Finalized','Cancelled') NOT NULL DEFAULT 'Pending',\n  `notes`               TEXT,\n  `createdAt`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `finalizedAt`         TIMESTAMP,\n  CONSTRAINT `fk_pf_grn`       FOREIGN KEY (`grnId`)              REFERENCES `goods_received_notes`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_po`        FOREIGN KEY (`poId`)               REFERENCES `purchase_orders`(`id`)      ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_supplier`  FOREIGN KEY (`supplierId`)         REFERENCES `suppliers`(`id`)           ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_warehouse` FOREIGN KEY (`warehouseBranchId`)  REFERENCES `branches`(`id`)            ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_user`      FOREIGN KEY (`finalizedByUserId`)  REFERENCES `users`(`id`)               ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_ledger`    FOREIGN KEY (`payableEntryId`)     REFERENCES `ledger_entries`(`id`)      ON DELETE SET NULL,\n  INDEX `idx_pf_grn` (`grnId`),\n  INDEX `idx_pf_po` (`poId`),\n  INDEX `idx_pf_supplier` (`supplierId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: PAYMENT ALLOCATION ENGINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── INVOICES ────────────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoices` (\n  `id`                INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceNo`         VARCHAR(32) NOT NULL UNIQUE,\n  `invoiceType`       ENUM('Sales','Purchase','CreditNote','DebitNote') NOT NULL,\n  `referenceId`       INT NOT NULL,\n  `supplierId`        INT,\n  `customerId`        INT,\n  `branchId`          INT NOT NULL,\n  `totalAmount`       DECIMAL(12,2) NOT NULL,\n  `paidAmount`        DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `outstandingAmount` DECIMAL(12,2) NOT NULL,\n  `creditAmount`      DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `status`            ENUM('Draft','Issued','PartiallyPaid','Paid','Overdue','Cancelled') NOT NULL DEFAULT 'Draft',\n  `dueDate`           TIMESTAMP,\n  `createdAt`         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `issuedAt`          TIMESTAMP,\n  `paidAt`            TIMESTAMP,\n  CONSTRAINT `fk_inv_supplier`  FOREIGN KEY (`supplierId`) REFERENCES `suppliers`(`id`)  ON DELETE SET NULL,\n  CONSTRAINT `fk_inv_customer`  FOREIGN KEY (`customerId`) REFERENCES `customers`(`id`)  ON DELETE SET NULL,\n  CONSTRAINT `fk_inv_branch`    FOREIGN KEY (`branchId`)   REFERENCES `branches`(`id`)   ON DELETE RESTRICT,\n  INDEX `idx_inv_type` (`invoiceType`),\n  INDEX `idx_inv_supplier` (`supplierId`),\n  INDEX `idx_inv_customer` (`customerId`),\n  INDEX `idx_inv_branch` (`branchId`),\n  INDEX `idx_inv_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── INVOICE PAYMENTS ────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoice_payments` (\n  `id`              INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`       INT NOT NULL,\n  `paymentAmount`   DECIMAL(12,2) NOT NULL,\n  `paymentMethod`   VARCHAR(32) NOT NULL,\n  `reference`       VARCHAR(128),\n  `notes`           TEXT,\n  `createdByUserId` INT NOT NULL,\n  `paymentDate`     TIMESTAMP NOT NULL,\n  `createdAt`       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_ip_invoice` FOREIGN KEY (`invoiceId`)       REFERENCES `invoices`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_ip_user`    FOREIGN KEY (`createdByUserId`) REFERENCES `users`(`id`)    ON DELETE RESTRICT,\n  INDEX `idx_ip_invoice` (`invoiceId`),\n  INDEX `idx_ip_date` (`paymentDate`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PAYMENT ALLOCATIONS ─────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `payment_allocations` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`        INT NOT NULL,\n  `paymentId`        INT NOT NULL,\n  `allocatedAmount`  DECIMAL(12,2) NOT NULL,\n  `allocationDate`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `notes`            TEXT,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_pa_invoice`  FOREIGN KEY (`invoiceId`)  REFERENCES `invoices`(`id`)           ON DELETE CASCADE,\n  CONSTRAINT `fk_pa_payment`  FOREIGN KEY (`paymentId`)  REFERENCES `invoice_payments`(`id`)   ON DELETE CASCADE,\n  INDEX `idx_pa_invoice` (`invoiceId`),\n  INDEX `idx_pa_payment` (`paymentId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── INVOICE AGING ───────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoice_aging` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`        INT NOT NULL UNIQUE,\n  `invoiceNo`        VARCHAR(32) NOT NULL,\n  `supplierId`       INT,\n  `customerId`       INT,\n  `branchId`         INT NOT NULL,\n  `totalAmount`      DECIMAL(12,2) NOT NULL,\n  `outstandingAmount` DECIMAL(12,2) NOT NULL,\n  `daysOverdue`      INT NOT NULL DEFAULT 0,\n  `agingBucket`      ENUM('Current','30Days','60Days','90Days','Over90Days') NOT NULL DEFAULT 'Current',\n  `dueDate`          TIMESTAMP,\n  `lastPaymentDate`  TIMESTAMP,\n  `updatedAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_ia_invoice`   FOREIGN KEY (`invoiceId`)  REFERENCES `invoices`(`id`)    ON DELETE CASCADE,\n  CONSTRAINT `fk_ia_supplier`  FOREIGN KEY (`supplierId`) REFERENCES `suppliers`(`id`)   ON DELETE SET NULL,\n  CONSTRAINT `fk_ia_customer`  FOREIGN KEY (`customerId`) REFERENCES `customers`(`id`)   ON DELETE SET NULL,\n  CONSTRAINT `fk_ia_branch`    FOREIGN KEY (`branchId`)   REFERENCES `branches`(`id`)    ON DELETE RESTRICT,\n  INDEX `idx_ia_supplier` (`supplierId`),\n  INDEX `idx_ia_customer` (`customerId`),\n  INDEX `idx_ia_aging` (`agingBucket`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway04.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 48yCYyFHTgav2j9.8fd33d3537ae --database 7ZcBDNvzQVdPenBD24E82P --execute \n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: STOCK INTEGRITY ENGINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── STOCK RESERVATIONS ──────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `stock_reservations` (\n  `id`              INT AUTO_INCREMENT PRIMARY KEY,\n  `inventoryItemId` INT NOT NULL,\n  `invoiceId`       INT NOT NULL,\n  `invoiceType`     ENUM('Sale','Transfer','PurchaseOrder') NOT NULL,\n  `branchId`        INT NOT NULL,\n  `productId`       INT NOT NULL,\n  `quantity`        INT NOT NULL DEFAULT 1,\n  `status`          ENUM('Active','Released','Consumed') NOT NULL DEFAULT 'Active',\n  `createdAt`       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `releasedAt`      TIMESTAMP,\n  CONSTRAINT `fk_sr_inventory` FOREIGN KEY (`inventoryItemId`) REFERENCES `inventory_items`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_sr_branch`    FOREIGN KEY (`branchId`)        REFERENCES `branches`(`id`)        ON DELETE CASCADE,\n  CONSTRAINT `fk_sr_product`   FOREIGN KEY (`productId`)       REFERENCES `products`(`id`)       ON DELETE CASCADE,\n  INDEX `idx_res_inventory` (`inventoryItemId`),\n  INDEX `idx_res_invoice` (`invoiceId`),\n  INDEX `idx_res_branch` (`branchId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: PURCHASE WORKFLOW PIPELINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── PURCHASE ORDERS ─────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_orders` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `poNo`             VARCHAR(32) NOT NULL UNIQUE,\n  `supplierId`       INT NOT NULL,\n  `warehouseBranchId` INT NOT NULL,\n  `createdByUserId`  INT NOT NULL,\n  `status`           ENUM('Draft','Submitted','Approved','Cancelled') NOT NULL DEFAULT 'Draft',\n  `totalAmount`      DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `notes`            TEXT,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `submittedAt`      TIMESTAMP,\n  `approvedAt`       TIMESTAMP,\n  `cancelledAt`      TIMESTAMP,\n  CONSTRAINT `fk_po_supplier`   FOREIGN KEY (`supplierId`)       REFERENCES `suppliers`(`id`)  ON DELETE RESTRICT,\n  CONSTRAINT `fk_po_warehouse`  FOREIGN KEY (`warehouseBranchId`) REFERENCES `branches`(`id`)   ON DELETE RESTRICT,\n  CONSTRAINT `fk_po_user`       FOREIGN KEY (`createdByUserId`)   REFERENCES `users`(`id`)      ON DELETE RESTRICT,\n  INDEX `idx_po_supplier` (`supplierId`),\n  INDEX `idx_po_warehouse` (`warehouseBranchId`),\n  INDEX `idx_po_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PURCHASE ORDER ITEMS ────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_order_items` (\n  `id`         INT AUTO_INCREMENT PRIMARY KEY,\n  `poId`       INT NOT NULL,\n  `productId`  INT NOT NULL,\n  `quantity`   INT NOT NULL,\n  `unitPrice`  DECIMAL(12,2) NOT NULL,\n  `totalPrice` DECIMAL(12,2) NOT NULL,\n  `createdAt`  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_poi_po`      FOREIGN KEY (`poId`)      REFERENCES `purchase_orders`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_poi_product` FOREIGN KEY (`productId`) REFERENCES `products`(`id`)        ON DELETE RESTRICT,\n  INDEX `idx_poi_po` (`poId`),\n  INDEX `idx_poi_product` (`productId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── GOODS RECEIVED NOTES ────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `goods_received_notes` (\n  `id`                  INT AUTO_INCREMENT PRIMARY KEY,\n  `grnNo`               VARCHAR(32) NOT NULL UNIQUE,\n  `poId`                INT NOT NULL,\n  `supplierId`          INT NOT NULL,\n  `warehouseBranchId`   INT NOT NULL,\n  `receivedByUserId`    INT NOT NULL,\n  `status`              ENUM('Pending','Received','Reversed') NOT NULL DEFAULT 'Pending',\n  `totalReceivedAmount` DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `notes`               TEXT,\n  `createdAt`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `receivedAt`          TIMESTAMP,\n  `reversedAt`          TIMESTAMP,\n  CONSTRAINT `fk_grn_po`        FOREIGN KEY (`poId`)                REFERENCES `purchase_orders`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_supplier`  FOREIGN KEY (`supplierId`)          REFERENCES `suppliers`(`id`)      ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_warehouse` FOREIGN KEY (`warehouseBranchId`)   REFERENCES `branches`(`id`)       ON DELETE RESTRICT,\n  CONSTRAINT `fk_grn_user`      FOREIGN KEY (`receivedByUserId`)    REFERENCES `users`(`id`)         ON DELETE RESTRICT,\n  INDEX `idx_grn_po` (`poId`),\n  INDEX `idx_grn_supplier` (`supplierId`),\n  INDEX `idx_grn_warehouse` (`warehouseBranchId`),\n  INDEX `idx_grn_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── GRN ITEMS ───────────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `grn_items` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`            INT NOT NULL,\n  `poItemId`         INT NOT NULL,\n  `productId`        INT NOT NULL,\n  `quantityReceived` INT NOT NULL,\n  `unitPrice`        DECIMAL(12,2) NOT NULL,\n  `totalPrice`       DECIMAL(12,2) NOT NULL,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_grni_grn`     FOREIGN KEY (`grnId`)     REFERENCES `goods_received_notes`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_grni_poitem`  FOREIGN KEY (`poItemId`)  REFERENCES `purchase_order_items`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_grni_product` FOREIGN KEY (`productId`) REFERENCES `products`(`id`)             ON DELETE RESTRICT,\n  INDEX `idx_grni_grn` (`grnId`),\n  INDEX `idx_grni_product` (`productId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── LANDING COSTS ───────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `landing_costs` (\n  `id`          INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`       INT NOT NULL,\n  `costType`    VARCHAR(64) NOT NULL,\n  `amount`      DECIMAL(12,2) NOT NULL,\n  `description` TEXT,\n  `createdAt`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_lc_grn` FOREIGN KEY (`grnId`) REFERENCES `goods_received_notes`(`id`) ON DELETE CASCADE,\n  INDEX `idx_lc_grn` (`grnId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PURCHASE FINALIZATIONS ──────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `purchase_finalizations` (\n  `id`                  INT AUTO_INCREMENT PRIMARY KEY,\n  `grnId`               INT NOT NULL,\n  `poId`                INT NOT NULL,\n  `supplierId`          INT NOT NULL,\n  `warehouseBranchId`   INT NOT NULL,\n  `finalizedByUserId`   INT NOT NULL,\n  `baseAmount`          DECIMAL(12,2) NOT NULL,\n  `totalLandingCosts`   DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `finalAmount`         DECIMAL(12,2) NOT NULL,\n  `payableEntryId`      INT,\n  `status`              ENUM('Pending','Finalized','Cancelled') NOT NULL DEFAULT 'Pending',\n  `notes`               TEXT,\n  `createdAt`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `finalizedAt`         TIMESTAMP,\n  CONSTRAINT `fk_pf_grn`       FOREIGN KEY (`grnId`)              REFERENCES `goods_received_notes`(`id`) ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_po`        FOREIGN KEY (`poId`)               REFERENCES `purchase_orders`(`id`)      ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_supplier`  FOREIGN KEY (`supplierId`)         REFERENCES `suppliers`(`id`)           ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_warehouse` FOREIGN KEY (`warehouseBranchId`)  REFERENCES `branches`(`id`)            ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_user`      FOREIGN KEY (`finalizedByUserId`)  REFERENCES `users`(`id`)               ON DELETE RESTRICT,\n  CONSTRAINT `fk_pf_ledger`    FOREIGN KEY (`payableEntryId`)     REFERENCES `ledger_entries`(`id`)      ON DELETE SET NULL,\n  INDEX `idx_pf_grn` (`grnId`),\n  INDEX `idx_pf_po` (`poId`),\n  INDEX `idx_pf_supplier` (`supplierId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n-- PHASE-2: PAYMENT ALLOCATION ENGINE\n-- ═════════════════════════════════════════════════════════════════════════════════════════════\n\n-- ─── INVOICES ────────────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoices` (\n  `id`                INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceNo`         VARCHAR(32) NOT NULL UNIQUE,\n  `invoiceType`       ENUM('Sales','Purchase','CreditNote','DebitNote') NOT NULL,\n  `referenceId`       INT NOT NULL,\n  `supplierId`        INT,\n  `customerId`        INT,\n  `branchId`          INT NOT NULL,\n  `totalAmount`       DECIMAL(12,2) NOT NULL,\n  `paidAmount`        DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `outstandingAmount` DECIMAL(12,2) NOT NULL,\n  `creditAmount`      DECIMAL(12,2) NOT NULL DEFAULT 0.00,\n  `status`            ENUM('Draft','Issued','PartiallyPaid','Paid','Overdue','Cancelled') NOT NULL DEFAULT 'Draft',\n  `dueDate`           TIMESTAMP,\n  `createdAt`         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `issuedAt`          TIMESTAMP,\n  `paidAt`            TIMESTAMP,\n  CONSTRAINT `fk_inv_supplier`  FOREIGN KEY (`supplierId`) REFERENCES `suppliers`(`id`)  ON DELETE SET NULL,\n  CONSTRAINT `fk_inv_customer`  FOREIGN KEY (`customerId`) REFERENCES `customers`(`id`)  ON DELETE SET NULL,\n  CONSTRAINT `fk_inv_branch`    FOREIGN KEY (`branchId`)   REFERENCES `branches`(`id`)   ON DELETE RESTRICT,\n  INDEX `idx_inv_type` (`invoiceType`),\n  INDEX `idx_inv_supplier` (`supplierId`),\n  INDEX `idx_inv_customer` (`customerId`),\n  INDEX `idx_inv_branch` (`branchId`),\n  INDEX `idx_inv_status` (`status`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── INVOICE PAYMENTS ────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoice_payments` (\n  `id`              INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`       INT NOT NULL,\n  `paymentAmount`   DECIMAL(12,2) NOT NULL,\n  `paymentMethod`   VARCHAR(32) NOT NULL,\n  `reference`       VARCHAR(128),\n  `notes`           TEXT,\n  `createdByUserId` INT NOT NULL,\n  `paymentDate`     TIMESTAMP NOT NULL,\n  `createdAt`       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_ip_invoice` FOREIGN KEY (`invoiceId`)       REFERENCES `invoices`(`id`) ON DELETE CASCADE,\n  CONSTRAINT `fk_ip_user`    FOREIGN KEY (`createdByUserId`) REFERENCES `users`(`id`)    ON DELETE RESTRICT,\n  INDEX `idx_ip_invoice` (`invoiceId`),\n  INDEX `idx_ip_date` (`paymentDate`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── PAYMENT ALLOCATIONS ─────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `payment_allocations` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`        INT NOT NULL,\n  `paymentId`        INT NOT NULL,\n  `allocatedAmount`  DECIMAL(12,2) NOT NULL,\n  `allocationDate`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `notes`            TEXT,\n  `createdAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_pa_invoice`  FOREIGN KEY (`invoiceId`)  REFERENCES `invoices`(`id`)           ON DELETE CASCADE,\n  CONSTRAINT `fk_pa_payment`  FOREIGN KEY (`paymentId`)  REFERENCES `invoice_payments`(`id`)   ON DELETE CASCADE,\n  INDEX `idx_pa_invoice` (`invoiceId`),\n  INDEX `idx_pa_payment` (`paymentId`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ─── INVOICE AGING ───────────────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS `invoice_aging` (\n  `id`               INT AUTO_INCREMENT PRIMARY KEY,\n  `invoiceId`        INT NOT NULL UNIQUE,\n  `invoiceNo`        VARCHAR(32) NOT NULL,\n  `supplierId`       INT,\n  `customerId`       INT,\n  `branchId`         INT NOT NULL,\n  `totalAmount`      DECIMAL(12,2) NOT NULL,\n  `outstandingAmount` DECIMAL(12,2) NOT NULL,\n  `daysOverdue`      INT NOT NULL DEFAULT 0,\n  `agingBucket`      ENUM('Current','30Days','60Days','90Days','Over90Days') NOT NULL DEFAULT 'Current',\n  `dueDate`          TIMESTAMP,\n  `lastPaymentDate`  TIMESTAMP,\n  `updatedAt`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  CONSTRAINT `fk_ia_invoice`   FOREIGN KEY (`invoiceId`)  REFERENCES `invoices`(`id`)    ON DELETE CASCADE,\n  CONSTRAINT `fk_ia_supplier`  FOREIGN KEY (`supplierId`) REFERENCES `suppliers`(`id`)   ON DELETE SET NULL,\n  CONSTRAINT `fk_ia_customer`  FOREIGN KEY (`customerId`) REFERENCES `customers`(`id`)   ON DELETE SET NULL,\n  CONSTRAINT `fk_ia_branch`    FOREIGN KEY (`branchId`)   REFERENCES `branches`(`id`)    ON DELETE RESTRICT,\n  INDEX `idx_ia_supplier` (`supplierId`),\n  INDEX `idx_ia_customer` (`customerId`),\n  INDEX `idx_ia_aging` (`agingBucket`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n",
  "rows": [],
  "messages": [],
  "stdout": "",
  "stderr": "",
  "execution_time_ms": 840
}